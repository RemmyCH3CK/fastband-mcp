name: Auto Update Project

on:
  issues:
    types: [closed, reopened]
  pull_request:
    types: [closed, opened, reopened]

env:
  PROJECT_NUMBER: 2

jobs:
  update-project:
    runs-on: ubuntu-latest
    steps:
      - name: Move issue to Done when closed
        if: github.event_name == 'issues' && github.event.action == 'closed'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const projectNumber = parseInt(process.env.PROJECT_NUMBER);

            // Get project
            const { data: { user } } = await github.rest.users.getByUsername({
              username: context.repo.owner
            });

            // Use GraphQL to update project item status
            const query = `
              query($owner: String!, $number: Int!) {
                user(login: $owner) {
                  projectV2(number: $number) {
                    id
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            number
                          }
                        }
                      }
                    }
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const result = await github.graphql(query, {
              owner: context.repo.owner,
              number: projectNumber
            });

            const project = result.user.projectV2;
            const statusField = project.fields.nodes.find(f => f.name === 'Status');
            const doneOption = statusField?.options?.find(o => o.name === 'Done');

            const projectItem = project.items.nodes.find(
              item => item.content?.number === issue.number
            );

            if (projectItem && statusField && doneOption) {
              const mutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { singleSelectOptionId: $optionId }
                  }) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `;

              await github.graphql(mutation, {
                projectId: project.id,
                itemId: projectItem.id,
                fieldId: statusField.id,
                optionId: doneOption.id
              });

              console.log(`Moved issue #${issue.number} to Done`);
            }

      - name: Move issue to In Progress when reopened
        if: github.event_name == 'issues' && github.event.action == 'reopened'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue = context.payload.issue;
            const projectNumber = parseInt(process.env.PROJECT_NUMBER);

            const query = `
              query($owner: String!, $number: Int!) {
                user(login: $owner) {
                  projectV2(number: $number) {
                    id
                    items(first: 100) {
                      nodes {
                        id
                        content {
                          ... on Issue {
                            number
                          }
                        }
                      }
                    }
                    fields(first: 20) {
                      nodes {
                        ... on ProjectV2SingleSelectField {
                          id
                          name
                          options {
                            id
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            const result = await github.graphql(query, {
              owner: context.repo.owner,
              number: projectNumber
            });

            const project = result.user.projectV2;
            const statusField = project.fields.nodes.find(f => f.name === 'Status');
            const inProgressOption = statusField?.options?.find(o => o.name === 'In Progress');

            const projectItem = project.items.nodes.find(
              item => item.content?.number === issue.number
            );

            if (projectItem && statusField && inProgressOption) {
              const mutation = `
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                  updateProjectV2ItemFieldValue(input: {
                    projectId: $projectId
                    itemId: $itemId
                    fieldId: $fieldId
                    value: { singleSelectOptionId: $optionId }
                  }) {
                    projectV2Item {
                      id
                    }
                  }
                }
              `;

              await github.graphql(mutation, {
                projectId: project.id,
                itemId: projectItem.id,
                fieldId: statusField.id,
                optionId: inProgressOption.id
              });

              console.log(`Moved issue #${issue.number} to In Progress`);
            }
