name: Secret Scanning

on:
  push:
    branches:
      - dual-product-rearch
  pull_request:
    branches:
      - dual-product-rearch

jobs:
  gitleaks:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate scanning

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_CONFIG: .gitleaks.toml
          GITLEAKS_ENABLE_SUMMARY: true

      - name: Summary
        if: always()
        run: |
          echo "## Secret Scanning" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ No secrets detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Scanned with [gitleaks](https://github.com/gitleaks/gitleaks)" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Potential secrets detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### What to do" >> $GITHUB_STEP_SUMMARY
            echo "1. **If real secret**: Rotate immediately, then remove from history" >> $GITHUB_STEP_SUMMARY
            echo "2. **If false positive**: Add to allowlist in \`.gitleaks.toml\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Adding to allowlist" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`toml" >> $GITHUB_STEP_SUMMARY
            echo "[allowlist]" >> $GITHUB_STEP_SUMMARY
            echo "paths = ['''path/to/file\\.ext\$''']" >> $GITHUB_STEP_SUMMARY
            echo "# or" >> $GITHUB_STEP_SUMMARY
            echo "regexes = ['''pattern-to-allow''']" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
